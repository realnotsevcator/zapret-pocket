MODPATH="/data/adb/modules/zapret"
CURLPATH="$MODPATH/curl"
CURRENTSTRATEGY=$(cat "$MODPATH/config/current-strategy" 2>/dev/null || echo "Unknown")
DNSCRYPTENABLE=$(cat "$MODPATH/config/dnscrypt-enable" 2>/dev/null || echo "0")
UPDATEONSTART=$(cat "$MODPATH/config/update-on-start" 2>/dev/null || echo "1")
CUSTOMLINKIPSETV4=$(cat "$MODPATH/config/ipset-v4-link" 2>/dev/null || echo "https://raw.githubusercontent.com/sevcator/zapret-lists/refs/heads/main/ipset-v4.txt")
CUSTOMLINKIPSETV6=$(cat "$MODPATH/config/ipset-v6-link" 2>/dev/null || echo "https://raw.githubusercontent.com/sevcator/zapret-lists/refs/heads/main/ipset-v6.txt")
CUSTOMLINKREESTR=$(cat "$MODPATH/config/reestr-link" 2>/dev/null || echo "https://raw.githubusercontent.com/sevcator/zapret-lists/refs/heads/main/reestr_filtered.txt")
IPV6ENABLE=$(cat "$MODPATH/config/ipv6-enable" 2>/dev/null || echo "0")
NETWORKTWEAKS=$(cat "$MODPATH/config/network-tweaks" 2>/dev/null || echo "0")
BYPASSCALLS=$(cat "$MODPATH/config/bypass-calls" 2>/dev/null || echo "0")

command_info() {
    echo "--- zapret Pocket ---"
    echo "! Current strategy: $CURRENTSTRATEGY"
    if [ "$UPDATEONSTART" = "1" ]; then
        echo "! Update on start enabled"
    else
        echo "! Update on start disabled"
    fi
    if [ "$IPV6ENABLE" = "1" ]; then
        echo "! IPv6 enabled"
    else
        echo "! IPv6 disabled"
    fi
    if [ "$NETWORKTWEAKS" = "1" ]; then
        echo "! Network tweaks enabled"
    else
        echo "! Network tweaks disabled"
    fi
    if [ "$BYPASSCALLS" = "1" ]; then
        echo "! Bypass calls enabled"
    else
        echo "! Bypass calls disabled"
    fi
    echo "------ Available commands ------"
    echo "  * Service control"
    echo "  start    - Start the zapret service"
    echo "  stop     - Stop the zapret service"
    echo "  restart  - Restart the zapret service"
    echo "  toggle   - Toggle the zapret service"
    echo "  setup    - Configure the zapret service"
    echo "  * Hostlists, ipsets and other"
    echo "  update   - Update the module files"
    echo "  search   - Search the domain/ip/cidr"
    echo "  custom   - Add/remove custom list/ipset"
    echo "  import-strategy - Import strategy from URL"
    echo "  cloaking  - Add/remove custom hosts"
    echo "  blocked-names   - Toggle domain in DNSCrypt blocked names"
    echo "  blocked-ips     - Toggle address in DNSCrypt blocked IPs"
    echo "  allowed-names   - Toggle domain in DNSCrypt allowed names"
    echo "  allowed-ips     - Toggle address in DNSCrypt allowed IPs"
    echo "  exclude  - Add/remove exclude list/ipset"
    return 0
}

start_service() {
    if pgrep -f "nfqws" >/dev/null 2>&1; then
        echo "! nfqws is already running"
        return 1
    else
        if [ -x "$MODPATH/service.sh" ]; then
            "$MODPATH/service.sh" >/dev/null 2>&1
            echo "- Service started"
            return 0
        else
            echo "! service.sh not found or not executable"
            return 1
        fi
    fi
}

stop_service() {
    if [ -x "$MODPATH/uninstall.sh" ]; then
        su -c "$MODPATH/uninstall.sh" >/dev/null 2>&1 && echo "- Service stopped" && return 0
        echo "! Failed to stop service"
        return 1
    else
        echo "! uninstall.sh not found or not executable"
        return 1
    fi
}

toggle_service() {
    . "$MODPATH/action.sh" && return 0 || return 1
}

restart_service() {
    stop_service && sleep 1 && start_service && return 0
    return 1
}

setup() {
    mkdir -p "$MODPATH/config"
    UPDATEONSTART="0"
    BYPASSCALLS="0"
    echo "! If the selection is anything other than \"Y\" or \"Yes\", it is considered a negative choice"

    echo -n "- Enable update on start? "
    read response
    case "$(echo "$response" | tr A-Z a-z)" in
        y|yes) echo "- Enabled"; UPDATEONSTART="1" ;;
    esac

    echo -n "- Enable IPv6? "
    read response
    case "$(echo "$response" | tr A-Z a-z)" in
        y|yes)
            echo "- Enabled"
            IPV6ENABLE="1"
        ;;
    esac
    
    echo -n "- Enable Network Tweaks? "
    read response
    case "$(echo "$response" | tr A-Z a-z)" in
        y|yes) echo "- Enabled"; NETWORKTWEAKS="1" ;;
    esac

    echo -n "- Enable bypass calls? "
    read response
    case "$(echo "$response" | tr A-Z a-z)" in
        y|yes) echo "- Enabled"; BYPASSCALLS="1" ;;
    esac

    if [ "$IPV6ENABLE" != "1" ]; then
        echo -n "- Enable DNSCrypt? "
        read response
        case "$(echo "$response" | tr A-Z a-z)" in
            y|yes) echo "- Enabled"; DNSCRYPTENABLE="1" ;;
        esac
    fi

    echo "- Available strategies:"
    find "$MODPATH/strategy" -type f -name "*.sh" 2>/dev/null | while IFS= read -r file; do
        strategy_name=$(basename "$file" .sh)
        echo "  * $strategy_name"
    done

    echo -n "- Enter the strategy name: "
    read user_strategy
    if [ ! -f "$MODPATH/strategy/${user_strategy}.sh" ]; then
        echo "! Invalid or empty strategy, using current: $CURRENTSTRATEGY"
        user_strategy="$CURRENTSTRATEGY"
    else
        echo "- Strategy selected!"
    fi

    if [ "$UPDATEONSTART" = "1" ]; then
        echo -n "- Do you want to change source links for update zapret files? "
        read resp
        case "$(echo "$resp" | tr A-Z a-z)" in
            y|yes)
                echo -n "- Enter link to ipset-v4.txt (leave blank to keep current): "
                read new_ipset_v4
                if [ -n "$new_ipset_v4" ]; then
                    CUSTOMLINKIPSETV4="$new_ipset_v4"
                    echo "- Link updated"
                else
                    echo "- Keeping old link: $CUSTOMLINKIPSETV4"
                fi

                echo -n "- Enter link to ipset-v6.txt (leave blank to keep current): "
                read new_ipset_v6
                if [ -n "$new_ipset_v6" ]; then
                    CUSTOMLINKIPSETV6="$new_ipset_v6"
                    echo "- Link updated"
                else
                    echo "- Keeping old link: $CUSTOMLINKIPSETV6"
                fi

                echo -n "- Enter link to reestr.txt (leave blank to keep current): "
                read new_reestr
                if [ -n "$new_reestr" ]; then
                    CUSTOMLINKREESTR="$new_reestr"
                    echo "- Link updated"
                else
                    echo "- Keeping old link: $CUSTOMLINKREESTR"
                fi
            ;;
        esac
    fi
    
    echo "$DNSCRYPTENABLE" > "$MODPATH/config/dnscrypt-enable"
    echo "$user_strategy" > "$MODPATH/config/current-strategy"
    echo "$UPDATEONSTART" > "$MODPATH/config/update-on-start"
    echo "$CUSTOMLINKIPSETV4" > "$MODPATH/config/ipset-v4-link"
    echo "$CUSTOMLINKIPSETV6" > "$MODPATH/config/ipset-v6-link"
    echo "$CUSTOMLINKREESTR" > "$MODPATH/config/reestr-link"
    echo "$IPV6ENABLE" > "$MODPATH/config/ipv6-enable"
    echo "$NETWORKTWEAKS" > "$MODPATH/config/network-tweaks"
    echo "$BYPASSCALLS" > "$MODPATH/config/bypass-calls"
    
    echo "- Done! Changes will apply on next start"
    return 0
}

update() {
    . "$MODPATH/update.sh" && return 0 || return 1
}

search() {
    query="$1"
    if [ -z "$query" ]; then
        echo "! No query provided"
        return 1
    fi

    SEARCH_DIRS="$MODPATH/list $MODPATH/ipset"
    total_matches=0
    file_matches=0

    for dir in $SEARCH_DIRS; do
        [ -d "$dir" ] || continue
        for file in "$dir"/*.txt; do
            [ -f "$file" ] || continue
            matches=$(grep -iF "$query" "$file" 2>/dev/null)
            if [ -n "$matches" ]; then
                file_matches=$((file_matches + 1))
                count=$(echo "$matches" | wc -l)
                total_matches=$((total_matches + count))
                echo "  * $(basename "$file") [$count match(es)]:"
                echo "$matches" | sort -u | sed 's/^/    /'
            fi
        done
    done

    if [ "$total_matches" -eq 0 ]; then
        echo "! Nothing found"
        return 1
    else
        echo "- Found $total_matches line(s) in $file_matches file(s)!"
        return 0
    fi
}

import_strategy() {
    url="$1"
    [ -n "$url" ] || { echo "! No URL provided"; return 1; }

    mkdir -p "$MODPATH/strategy"

    filename="${url%%\?*}"
    filename="${filename##*/}"
    [ "${filename##*.}" = "sh" ] || filename="downloaded-$(date +%Y%m%d%H%M%S).sh"

    if "$CURLPATH" -fsSL -o "$MODPATH/strategy/$filename" "$url"; then
        chmod +x "$MODPATH/strategy/$filename"
        echo "- Saved as $filename"
    else
        echo "! Download failed"
        return 1
    fi
}

custom() {
    entry="$1"
    [ -z "$entry" ] && echo "! No domain/IP/CIDR provided" && return 1

    LIST_CUSTOM="$MODPATH/list/custom.txt"
    IPSET_CUSTOM="$MODPATH/ipset/custom.txt"

    mkdir -p "$(dirname "$LIST_CUSTOM")" "$(dirname "$IPSET_CUSTOM")"
    touch "$LIST_CUSTOM" "$IPSET_CUSTOM"

    if grep -Fxq "$entry" "$LIST_CUSTOM" 2>/dev/null || grep -Fxq "$entry" "$IPSET_CUSTOM" 2>/dev/null; then
        for file in "$LIST_CUSTOM" "$IPSET_CUSTOM"; do
            [ -f "$file" ] || continue
            if grep -Fxq "$entry" "$file" 2>/dev/null; then
                grep -Fvx "$entry" "$file" > "$file.tmp" && mv "$file.tmp" "$file"
            fi
        done
        echo "- Removed"
        return 0
    fi

    if find "$MODPATH/list" "$MODPATH/ipset" -type f -name "*.txt" ! -name "custom.txt" 2>/dev/null | xargs grep -Fq "$entry" 2>/dev/null; then
        echo "! Already added in other lists, aborted"
        return 1
    fi

    if echo "$entry" | grep -q "/"; then
        printf '%s\n' "$entry" >> "$IPSET_CUSTOM"
    else
        printf '%s\n' "$entry" >> "$LIST_CUSTOM"
    fi

    echo "- Added"
    return 0
}

exclude() {
    entry="$1"
    [ -z "$entry" ] && echo "! No domain/IP/CIDR provided" && return 1

    LIST_EXCLUDE="$MODPATH/list/exclude.txt"
    IPSET_EXCLUDE="$MODPATH/ipset/exclude.txt"

    mkdir -p "$(dirname "$LIST_EXCLUDE")" "$(dirname "$IPSET_EXCLUDE")"
    touch "$LIST_EXCLUDE" "$IPSET_EXCLUDE"

    if grep -Fxq "$entry" "$LIST_EXCLUDE" 2>/dev/null || grep -Fxq "$entry" "$IPSET_EXCLUDE" 2>/dev/null; then
        for file in "$LIST_EXCLUDE" "$IPSET_EXCLUDE"; do
            [ -f "$file" ] || continue
            if grep -Fxq "$entry" "$file" 2>/dev/null; then
                grep -Fvx "$entry" "$file" > "$file.tmp" && mv "$file.tmp" "$file"
            fi
        done
        echo "- Removed"
        return 0
    fi

    if echo "$entry" | grep -q "/"; then
        printf '%s\n' "$entry" >> "$IPSET_EXCLUDE"
    else
        printf '%s\n' "$entry" >> "$LIST_EXCLUDE"
    fi

    echo "- Added"
    return 0
}

cloaking() {
    val1="$1"
    val2="$2"

    CLOAKING_FILE="$MODPATH/dnscrypt/custom-cloaking-rules.txt"
    GLOBAL_CLOAKING_FILE="$MODPATH/dnscrypt/cloaking-rules.txt"

    if [ -z "$val1" ]; then
        echo "! Usage: cloaking <domain> [replacement]"
        return 1
    fi

    mkdir -p "$(dirname "$CLOAKING_FILE")"
    touch "$CLOAKING_FILE"

    if [ -z "$val2" ]; then
        if grep -E -q "^($val1|\S+\.$val1)\s+" "$CLOAKING_FILE"; then
            sed -i -E "\|^($val1|\S+\.$val1)\s+.*$|d" "$CLOAKING_FILE"
            echo "- Removed"
        else
            echo "! Nothing to remove"
        fi
        return 0
    fi

    line="$val1 $val2"

    if grep -Fxq "$line" "$CLOAKING_FILE"; then
        grep -Fxv "$line" "$CLOAKING_FILE" > "$CLOAKING_FILE.tmp" && mv "$CLOAKING_FILE.tmp" "$CLOAKING_FILE"
        echo "- Removed"
        return 0
    fi

    if grep -Eq "^$val1\s+" "$CLOAKING_FILE" || grep -Eq "^\S+\.$val1\s+" "$CLOAKING_FILE"; then
        echo "! Already added"
        return 1
    fi
    if [ -f "$GLOBAL_CLOAKING_FILE" ]; then
        if grep -Eq "^$val1\s+" "$GLOBAL_CLOAKING_FILE" || grep -Eq "^\S+\.$val1\s+" "$GLOBAL_CLOAKING_FILE"; then
            echo "! Domain or subdomain already exists. Aborted"
            return 1
        fi
    fi

    printf '%s\n' "$line" >> "$CLOAKING_FILE"
    echo "- Added"
    return 0
}

dnscrypt_manage_list() {
    list_file="$1"
    entry="$2"
    description="$3"
    helper_script="$4"

    if [ -z "$entry" ]; then
        echo "! No $description provided"
        return 1
    fi

    mkdir -p "$(dirname "$list_file")"
    touch "$list_file"

    if grep -Fxq "$entry" "$list_file" 2>/dev/null; then
        tmp_file="${list_file}.tmp"
        grep -Fvx "$entry" "$list_file" > "$tmp_file" 2>/dev/null || true
        mv "$tmp_file" "$list_file"
        action="Removed"
    else
        printf '%s\n' "$entry" >> "$list_file"
        action="Added"
    fi

    if [ -n "$helper_script" ] && [ -f "$MODPATH/dnscrypt/$helper_script" ]; then
        sh "$MODPATH/dnscrypt/$helper_script" disappend >/dev/null 2>&1 || true
        sh "$MODPATH/dnscrypt/$helper_script" append >/dev/null 2>&1 || true
    fi

    echo "- $action"
    return 0
}

dnscrypt_blocked_names() {
    dnscrypt_manage_list "$MODPATH/dnscrypt/custom-blocked-names.txt" "$1" "domain" "custom-blocked-names.sh"
}

dnscrypt_blocked_ips() {
    dnscrypt_manage_list "$MODPATH/dnscrypt/custom-blocked-ips.txt" "$1" "IP address" "custom-blocked-ips.sh"
}

dnscrypt_allowed_names() {
    dnscrypt_manage_list "$MODPATH/dnscrypt/custom-allowed-names.txt" "$1" "domain" "custom-allowed-names.sh"
}

dnscrypt_allowed_ips() {
    dnscrypt_manage_list "$MODPATH/dnscrypt/custom-allowed-ips.txt" "$1" "IP address" "custom-allowed-ips.sh"
}

unknown_command() {
    echo "! Unknown command: $1"
    return 1
}

case "$1" in
    ""|help|-help|--help|h|--h|-h) command_info ;;
    start)      start_service ;;
    stop)       stop_service ;;
    toggle)     toggle_service ;;
    restart)    restart_service ;;
    setup)      setup ;;
    update)     update ;;
    search)     search "$2" ;;
    custom)     custom "$2" ;;
    import-strategy) import_strategy "$2" ;;
    exclude)    exclude "$2" ;;
    cloaking)   cloaking "$2" "$3" ;;
    blocked-names) dnscrypt_blocked_names "$2" ;;
    blocked-ips)   dnscrypt_blocked_ips "$2" ;;
    allowed-names) dnscrypt_allowed_names "$2" ;;
    allowed-ips)   dnscrypt_allowed_ips "$2" ;;
    *)          unknown_command "$1" ;;
esac
